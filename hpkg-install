#!/bin/bash

# Hydra Package Installer
# A custom package installer for .hpkg files

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: Please run as root${NC}"
    exit 1
fi

# Check if package file is provided
if [ -z "$1" ]; then
    echo -e "${RED}Usage: $0 <package.hpkg>${NC}"
    exit 1
fi

PACKAGE="$1"

# Check if file exists
if [ ! -f "$PACKAGE" ]; then
    echo -e "${RED}Error: Package file not found: $PACKAGE${NC}"
    exit 1
fi

# Check file extension
if [[ ! "$PACKAGE" =~ \.hpkg$ ]]; then
    echo -e "${RED}Error: Not a valid .hpkg package${NC}"
    exit 1
fi

echo -e "${YELLOW}Installing package: $PACKAGE${NC}"

# Create temporary directory
TMPDIR=$(mktemp -d)
trap 'rm -rf "$TMPDIR"' EXIT

# Extract package
echo "Extracting package..."
tar xzf "$PACKAGE" -C "$TMPDIR"

# Check for control file
if [ ! -f "$TMPDIR/control/control.txt" ]; then
    echo -e "${RED}Error: Invalid package format - missing control file${NC}"
    exit 1
fi

# Read package metadata
PACKAGE_NAME=$(grep "^Package:" "$TMPDIR/control/control.txt" | cut -d':' -f2 | tr -d ' ')
VERSION=$(grep "^Version:" "$TMPDIR/control/control.txt" | cut -d':' -f2 | tr -d ' ')
ARCH=$(grep "^Architecture:" "$TMPDIR/control/control.txt" | cut -d':' -f2 | tr -d ' ')

echo -e "${GREEN}Package: $PACKAGE_NAME${NC}"
echo -e "${GREEN}Version: $VERSION${NC}"
echo -e "${GREEN}Architecture: $ARCH${NC}"

# Check dependencies
if [ -f "$TMPDIR/control/control.txt" ]; then
    DEPS=$(grep "^Depends:" "$TMPDIR/control/control.txt" | cut -d':' -f2 | tr -d ' ')
    if [ ! -z "$DEPS" ]; then
        echo "Checking dependencies..."
        for dep in $DEPS; do
            if ! dpkg -l | grep -q "^ii  $dep "; then
                echo -e "${RED}Missing dependency: $dep${NC}"
                exit 1
            fi
        done
    fi
fi

# Create package directories
mkdir -p "/var/lib/hpkg/data/$PACKAGE_NAME"
mkdir -p "/var/lib/hpkg/scripts/$PACKAGE_NAME"

# Run pre-install script if exists
if [ -f "$TMPDIR/scripts/preinst.sh" ]; then
    echo "Running pre-install script..."
    bash "$TMPDIR/scripts/preinst.sh"
fi

# Copy files
echo "Installing files..."
cp -r "$TMPDIR/data/"* /
cp -r "$TMPDIR/scripts/"* "/var/lib/hpkg/scripts/$PACKAGE_NAME/"

# Run post-install script if exists
if [ -f "$TMPDIR/scripts/postinst.sh" ]; then
    echo "Running post-install script..."
    bash "$TMPDIR/scripts/postinst.sh"
fi

# Update package database
echo "$PACKAGE_NAME $VERSION $ARCH" >> /var/lib/hpkg/installed
echo "$PACKAGE_NAME $VERSION $ARCH installed" >> /var/lib/hpkg/status

echo -e "${GREEN}Package installed successfully!${NC}" 